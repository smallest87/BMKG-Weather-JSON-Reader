<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Cuaca Universal (ViewModel)</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; }

        /* Upload Section */
        .upload-container { text-align: center; padding: 40px; background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto 20px auto; }
        input[type="file"] { margin-top: 15px; padding: 10px; border: 2px dashed #ccc; border-radius: 8px; width: 100%; box-sizing: border-box; }

        /* Dashboard & Controls */
        #dashboard { display: none; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 15px 25px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; flex-wrap: wrap; gap: 10px; border-left: 5px solid var(--secondary-color); }
        .control-group { display: flex; gap: 10px; align-items: center; }
        select { padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
        
        /* View Switcher Buttons */
        .view-btn { background: #eee; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 1.2em; transition: 0.2s; }
        .view-btn.active { background: var(--secondary-color); color: white; }
        .view-btn:hover { background: #ddd; }
        .view-btn.active:hover { background: #2980b9; }

        /* Region Info */
        .region-info { background: linear-gradient(135deg, #2980b9, #3498db); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(41, 128, 185, 0.3); }
        .region-info.desa-mode { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .region-meta { display: flex; gap: 20px; font-size: 0.85em; background: rgba(0,0,0,0.15); padding: 10px; border-radius: 8px; width: fit-content; margin-top: 10px;}

        /* --- LAYOUT 1: GRID (CARD) --- */
        .forecast-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        
        .weather-card {
            background: var(--card-bg); border-radius: 12px; padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.2s;
            display: flex; flex-direction: column; justify-content: space-between;
            border-left: 5px solid #bdc3c7;
        }
        .weather-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Card Internals */
        .card-header { font-size: 0.9em; color: #7f8c8d; margin-bottom: 10px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        .card-date { display: block; font-weight: bold; color: #2c3e50; }
        .card-time { font-size: 0.9em; color: #e67e22; font-weight: 600; }
        .main-weather { display: flex; align-items: center; justify-content: space-between; margin: 10px 0; }
        .temp-display { font-size: 2em; font-weight: bold; color: #333; }
        .condition-text { font-weight: 500; color: #555; margin-bottom: 15px; text-transform: capitalize; }
        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85em; color: #666; background: #f8f9fa; padding: 10px; border-radius: 8px; }
        .detail-item span { display: block; color: #999; font-size: 0.8em; margin-bottom: 2px;}

        /* --- LAYOUT 2: LIST (BARIS) --- */
        .forecast-list-container { display: flex; flex-direction: column; gap: 10px; }

        .weather-list-item {
            background: white; border-radius: 8px; padding: 10px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex;
            align-items: center; justify-content: space-between;
            border-left: 5px solid #bdc3c7; transition: 0.2s;
            flex-wrap: wrap; gap: 15px;
        }
        .weather-list-item:hover { transform: translateX(5px); }

        .list-left { min-width: 100px; }
        .list-time { display: block; font-weight: bold; color: #e67e22; font-size: 1.1em; }
        .list-date { font-size: 0.85em; color: #7f8c8d; }

        .list-center { display: flex; align-items: center; gap: 15px; flex-grow: 1; }
        .list-temp-group { display: flex; flex-direction: column; }
        .list-temp { font-size: 1.4em; font-weight: bold; color: #333; }
        .list-condition { font-size: 0.9em; color: #666; }

        .list-right { display: flex; gap: 20px; font-size: 0.9em; color: #555; flex-wrap: wrap; }
        .list-stat { background: #f8f9fa; padding: 5px 10px; border-radius: 15px; }

        /* Icons & Colors (Shared) */
        .weather-icon-img { width: 50px; height: 50px; object-fit: contain; }
        .weather-icon-display { font-size: 2em; }
        
        .rain { border-left-color: #3498db !important; }
        .cloudy { border-left-color: #95a5a6 !important; }
        .sunny { border-left-color: #f1c40f !important; }
        .clear { border-left-color: #f39c12 !important; }
        .fog { border-left-color: #bdc3c7 !important; }
        .thunder { border-left-color: #8e44ad !important; }

        @media (max-width: 600px) {
            .weather-list-item { flex-direction: column; align-items: flex-start; }
            .list-right { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>

    <div class="upload-container" id="uploadSection">
        <h2>üìÇ Monitor Cuaca Universal</h2>
        <p>Upload JSON BMKG (Kecamatan/Desa)</p>
        <input type="file" id="fileInput" accept=".json">
    </div>

    <div id="dashboard">
        <div class="header-bar">
            <h3 id="mainTitle">üå§Ô∏è Data Cuaca</h3>
            
            <div class="control-group">
                <div class="select-wrapper">
                    <select id="regionSelect">
                        <option value="">-- Pilih Wilayah --</option>
                    </select>
                </div>
                
                <button class="view-btn active" onclick="switchView('CARD')" title="Tampilan Kartu">‚äû</button>
                <button class="view-btn" onclick="switchView('LIST')" title="Tampilan Daftar">‚ò∞</button>
            </div>
        </div>

        <div id="contentArea">
            <div id="regionInfo" class="region-info" style="display:none;"></div>
            <div id="forecastContainer"></div>
        </div>
    </div>

    <script src="view_model.js"></script>
    
    <script>
        let weatherData = [];
        let uiMode = 'KECAMATAN';
        let currentRegionData = null; // Menyimpan data wilayah yang sedang dipilih
        
        // Inisialisasi ViewModel
        const viewModel = new WeatherViewModel();

        // 1. Handle File Upload
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    weatherData = JSON.parse(e.target.result);
                    detectUiTheme(); 
                    initDashboard();
                } catch (error) {
                    alert("Error: File JSON tidak valid.");
                    console.error(error);
                }
            };
            reader.readAsText(file);
        });

        // 2. Fungsi Ganti Tampilan (Dipanggil tombol)
        function switchView(mode) {
            // Update UI Button Active State
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            if(mode === 'CARD') document.querySelector('.view-btn[title="Tampilan Kartu"]').classList.add('active');
            else document.querySelector('.view-btn[title="Tampilan Daftar"]').classList.add('active');

            // Update ViewModel & Re-render jika ada data
            viewModel.setViewMode(mode);
            if (currentRegionData) {
                const standardizedData = normalizeForecastData(currentRegionData.prakiraan);
                viewModel.render('forecastContainer', standardizedData);
            }
        }

        // 3. Deteksi Tema UI
        function detectUiTheme() {
            if (weatherData.length > 0) {
                const sample = weatherData[0];
                if (sample.administrasi && sample.administrasi.desa) {
                    uiMode = 'DESA';
                } else {
                    uiMode = 'KECAMATAN';
                }
            }
        }

        // 4. Inisialisasi Dashboard
        function initDashboard() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            const select = document.getElementById('regionSelect');
            select.innerHTML = '<option value="">-- Pilih Wilayah --</option>';
            
            weatherData.sort((a, b) => a.wilayah.localeCompare(b.wilayah));

            weatherData.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = item.wilayah;
                select.appendChild(option);
            });

            select.addEventListener('change', (e) => {
                if(e.target.value !== "") {
                    // Simpan data terpilih ke variabel global
                    currentRegionData = weatherData[e.target.value];
                    renderHeader(currentRegionData);
                    
                    // Render isi menggunakan ViewModel
                    const standardizedData = normalizeForecastData(currentRegionData.prakiraan);
                    viewModel.render('forecastContainer', standardizedData);
                } else {
                    document.getElementById('regionInfo').style.display = 'none';
                    document.getElementById('forecastContainer').innerHTML = '';
                    currentRegionData = null;
                }
            });

            if(weatherData.length > 0) {
                select.value = 0;
                select.dispatchEvent(new Event('change'));
            }
        }

        // 5. Render Header Info (Masih di main script karena ini statis)
        function renderHeader(data) {
            const regionInfo = document.getElementById('regionInfo');
            const titleElement = document.getElementById('mainTitle');
            
            regionInfo.style.display = 'block';
            
            if (uiMode === 'DESA') {
                regionInfo.className = 'region-info desa-mode';
                titleElement.innerText = `üå§Ô∏è ${data.administrasi.desa || data.wilayah}`;
                regionInfo.innerHTML = `
                    <h2>üìç ${data.administrasi.desa || data.wilayah}</h2>
                    <div class="region-meta">
                        <div>Kec. ${data.administrasi.kecamatan}</div>
                        <div>${data.administrasi.kotkab}</div>
                    </div>
                `;
            } else {
                regionInfo.className = 'region-info';
                titleElement.innerText = `üå§Ô∏è ${data.wilayah}`;
                regionInfo.innerHTML = `
                    <h2>üìç ${data.wilayah}</h2>
                    <div class="region-meta">
                        <div>Kecamatan: ${data.administrasi.kecamatan || data.wilayah}</div>
                        <div>${data.administrasi.kotkab}</div>
                    </div>
                `;
            }
        }

        // 6. Data Normalizer (Penting agar ViewModel terima data bersih)
        function normalizeForecastData(prakiraanRaw) {
            let results = [];
            let isNested = false;
            
            if (prakiraanRaw.length > 0 && prakiraanRaw[0].hasOwnProperty("0")) {
                isNested = true;
            }

            if (isNested) {
                prakiraanRaw.forEach(chunk => {
                    Object.values(chunk).forEach(item => {
                        const d = new Date(item.local_datetime);
                        results.push({
                            rawDate: d,
                            dateStr: d.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'short' }),
                            timeStr: d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                            temp: item.t,
                            condition: item.weather_desc,
                            humidity: item.hu + '%',
                            wind: `${item.ws} m/s`,
                            clouds: item.tcc,
                            visibility: item.vs_text,
                            iconUrl: item.image
                        });
                    });
                });
            } else {
                prakiraanRaw.forEach(item => {
                    const d = new Date(item.waktu_lokal || item.local_datetime);
                    results.push({
                        rawDate: d,
                        dateStr: d.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'short' }),
                        timeStr: d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                        temp: item.suhu_max || item.t,
                        condition: item.kondisi || item.weather_desc,
                        humidity: item.kelembapan_min ? `${item.kelembapan_min}-${item.kelembapan_max}%` : `${item.hu}%`,
                        wind: item.kecepatan_angin ? `${item.kecepatan_angin} km/j` : `${item.ws} m/s`,
                        clouds: item.tcc,
                        visibility: item.vs_text ? item.vs_text : (item.vs ? (item.vs / 1000).toFixed(1) + ' km' : '-'),
                        iconUrl: item.image || null
                    });
                });
            }
            return results.sort((a, b) => a.rawDate - b.rawDate);
        }
    </script>
</body>
</html>