<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Cuaca Universal (Auto-Detect)</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        /* --- Upload Section --- */
        .upload-container {
            text-align: center;
            padding: 40px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto 20px auto;
        }

        input[type="file"] {
            margin-top: 15px; padding: 10px;
            border: 2px dashed #ccc; border-radius: 8px;
            width: 100%; box-sizing: border-box;
        }

        /* --- Dashboard --- */
        #dashboard { display: none; }

        .header-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg); padding: 15px 25px;
            border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
            border-left: 5px solid var(--secondary-color);
        }

        #mainTitle { margin: 0; font-size: 1.5em; }
        .select-wrapper { flex-grow: 1; max-width: 300px; }
        select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }

        /* --- Region Info Box --- */
        .region-info {
            background: linear-gradient(135deg, #2980b9, #3498db);
            color: white; padding: 20px; border-radius: 12px;
            margin-bottom: 20px; box-shadow: 0 4px 10px rgba(41, 128, 185, 0.3);
        }
        .region-info.desa-mode { background: linear-gradient(135deg, #27ae60, #2ecc71); }

        .region-info h2 { margin: 0 0 5px 0; }
        .region-breadcrumbs { font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; }
        .region-meta { 
            display: flex; gap: 20px; font-size: 0.85em; 
            background: rgba(0,0,0,0.15); padding: 10px; 
            border-radius: 8px; width: fit-content;
        }

        /* --- Grid Layout --- */
        .forecast-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px;
        }

        /* --- Weather Card --- */
        .weather-card {
            background: var(--card-bg); border-radius: 12px; padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.2s;
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; overflow: hidden; border-left: 5px solid #bdc3c7;
        }
        .weather-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* Dynamic Border Colors */
        .weather-card.rain { border-left-color: #3498db; }
        .weather-card.cloudy { border-left-color: #95a5a6; }
        .weather-card.sunny { border-left-color: #f1c40f; }
        .weather-card.clear { border-left-color: #f39c12; }
        .weather-card.fog { border-left-color: #bdc3c7; }
        .weather-card.thunder { border-left-color: #8e44ad; }

        .card-header {
            font-size: 0.9em; color: #7f8c8d; margin-bottom: 10px;
            border-bottom: 1px solid #f0f0f0; padding-bottom: 8px;
        }
        .card-date { display: block; font-weight: bold; color: #2c3e50; }
        .card-time { font-size: 0.9em; color: #e67e22; font-weight: 600; }

        .main-weather { display: flex; align-items: center; justify-content: space-between; margin: 10px 0; }
        .weather-icon-display { font-size: 2.5em; }
        .weather-icon-img { width: 60px; height: 60px; object-fit: contain; }
        .temp-display { font-size: 2em; font-weight: bold; color: #333; }
        .condition-text { font-weight: 500; color: #555; margin-bottom: 15px; text-transform: capitalize; }

        .details-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
            font-size: 0.85em; color: #666; background: #f8f9fa;
            padding: 10px; border-radius: 8px;
        }
        .detail-item span { display: block; color: #999; font-size: 0.8em; margin-bottom: 2px;}

        @media (max-width: 600px) {
            .header-bar { flex-direction: column; align-items: stretch; }
            .select-wrapper { max-width: 100%; }
            .region-meta { flex-direction: column; gap: 5px; }
        }
    </style>
</head>
<body>

    <div class="upload-container" id="uploadSection">
        <h2>üìÇ Monitor Cuaca Universal</h2>
        <p>Mendukung semua format JSON BMKG (Desa & Kecamatan).</p>
        <input type="file" id="fileInput" accept=".json">
    </div>

    <div id="dashboard">
        <div class="header-bar">
            <h3 id="mainTitle">üå§Ô∏è Data Cuaca</h3>
            <div class="select-wrapper">
                <select id="regionSelect">
                    <option value="">-- Pilih Wilayah --</option>
                </select>
            </div>
        </div>

        <div id="contentArea">
            <div id="regionInfo" class="region-info" style="display:none;"></div>
            <div id="forecastGrid" class="forecast-grid"></div>
        </div>
    </div>

    <script>
        let weatherData = [];
        let uiMode = 'KECAMATAN'; // 'DESA' (Hijau) atau 'KECAMATAN' (Biru) - hanya untuk UI

        // 1. Handle File Upload
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    weatherData = JSON.parse(e.target.result);
                    detectUiTheme(); 
                    initDashboard();
                } catch (error) {
                    alert("Error: File JSON tidak valid.");
                    console.error(error);
                }
            };
            reader.readAsText(file);
        });

        // 2. Deteksi Tema UI (Hanya Warna)
        function detectUiTheme() {
            if (weatherData.length > 0) {
                const sample = weatherData[0];
                if (sample.administrasi && sample.administrasi.desa) {
                    uiMode = 'DESA';
                } else {
                    uiMode = 'KECAMATAN';
                }
            }
        }

        // 3. Inisialisasi Dashboard
        function initDashboard() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            const select = document.getElementById('regionSelect');
            select.innerHTML = '<option value="">-- Pilih Wilayah --</option>';
            
            // Sort
            weatherData.sort((a, b) => a.wilayah.localeCompare(b.wilayah));

            weatherData.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = item.wilayah;
                select.appendChild(option);
            });

            select.addEventListener('change', (e) => {
                if(e.target.value !== "") {
                    renderRegion(weatherData[e.target.value]);
                } else {
                    document.getElementById('regionInfo').style.display = 'none';
                    document.getElementById('forecastGrid').innerHTML = '';
                    document.getElementById('mainTitle').innerText = 'üå§Ô∏è Data Cuaca';
                }
            });

            if(weatherData.length > 0) {
                select.value = 0;
                renderRegion(weatherData[0]);
            }
        }

        // 4. Render Wilayah
        function renderRegion(data) {
            const regionInfo = document.getElementById('regionInfo');
            const forecastGrid = document.getElementById('forecastGrid');
            const titleElement = document.getElementById('mainTitle');
            
            regionInfo.style.display = 'block';
            
            // --- UI Header Logic ---
            if (uiMode === 'DESA') {
                regionInfo.className = 'region-info desa-mode';
                titleElement.innerText = `üå§Ô∏è Cuaca Desa ${data.administrasi.desa || data.wilayah}`;
                regionInfo.innerHTML = `
                    <h2>üìç ${data.administrasi.desa || data.wilayah}</h2>
                    <div class="region-breadcrumbs">
                        Kec. ${data.administrasi.kecamatan} &bull; ${data.administrasi.kotkab} &bull; ${data.administrasi.provinsi}
                    </div>
                    <div class="region-meta">
                        <div><strong>Lat/Lon:</strong> ${data.administrasi.lat}, ${data.administrasi.lon}</div>
                        <div><strong>Zona:</strong> ${data.administrasi.timezone}</div>
                    </div>
                `;
            } else {
                regionInfo.className = 'region-info';
                titleElement.innerText = `üå§Ô∏è Cuaca Kec. ${data.wilayah}`;
                regionInfo.innerHTML = `
                    <h2>üìç ${data.wilayah}</h2>
                    <div class="region-breadcrumbs">
                        Kabupaten ${data.administrasi.kotkab} &bull; ${data.administrasi.provinsi}
                    </div>
                    <div class="region-meta">
                        <div><strong>Kecamatan:</strong> ${data.administrasi.kecamatan || data.wilayah}</div>
                        <div><strong>Lat/Lon:</strong> ${data.administrasi.lat}, ${data.administrasi.lon}</div>
                    </div>
                `;
            }

            // --- Normalize Data Logic (THE FIX) ---
            const standardForecasts = normalizeForecastData(data.prakiraan);

            // --- Render Cards ---
            forecastGrid.innerHTML = '';
            
            standardForecasts.forEach(fc => {
                const card = document.createElement('div');
                const weatherClass = getWeatherClass(fc.condition);
                card.className = `weather-card ${weatherClass}`;

                // Tentukan Icon: Prioritas URL gambar, fallback ke Emoji
                let iconHtml = '';
                if (fc.iconUrl) {
                    iconHtml = `<img src="${fc.iconUrl}" alt="${fc.condition}" class="weather-icon-img" onerror="this.style.display='none'">`;
                } else {
                    iconHtml = `<div class="weather-icon-display">${getEmojiIcon(fc.condition)}</div>`;
                }

                card.innerHTML = `
                    <div class="card-header">
                        <span class="card-date">${fc.dateStr}</span>
                        <span class="card-time">üïí ${fc.timeStr} WIB</span>
                    </div>
                    
                    <div class="main-weather">
                        ${iconHtml}
                        <div class="temp-display">${fc.temp}¬∞C</div>
                    </div>
                    
                    <div class="condition-text">${fc.condition}</div>
                    
                    <div class="details-grid">
                        <div class="detail-item">
                            <span>Kelembapan</span>
                            üíß ${fc.humidity}
                        </div>
                        <div class="detail-item">
                            <span>Angin</span>
                            üí® ${fc.wind}
                        </div>
                        <div class="detail-item">
                            <span>Awan</span>
                            ‚òÅÔ∏è ${fc.clouds}%
                        </div>
                        <div class="detail-item">
                            <span>Jarak Pandang</span>
                            üëÅÔ∏è ${fc.visibility}
                        </div>
                    </div>
                `;
                forecastGrid.appendChild(card);
            });
        }

        // --- Helper: Normalize Data (PERBAIKAN UTAMA) ---
        function normalizeForecastData(prakiraanRaw) {
            let results = [];

            // Cek Struktur Data: Apakah Nested (ada key "0") atau Flat (langsung object)?
            let isNested = false;
            if (prakiraanRaw.length > 0) {
                // Jika elemen pertama punya key "0", maka nested.
                if (prakiraanRaw[0].hasOwnProperty("0")) {
                    isNested = true;
                }
            }

            if (isNested) {
                // Pola 1: Struktur Nested (biasanya ada di API Desa tertentu)
                prakiraanRaw.forEach(chunk => {
                    Object.values(chunk).forEach(item => {
                        const d = new Date(item.local_datetime);
                        results.push({
                            rawDate: d,
                            dateStr: d.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'short' }),
                            timeStr: d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                            temp: item.t,
                            condition: item.weather_desc, // Gunakan weather_desc
                            humidity: item.hu + '%',
                            wind: `${item.ws} m/s (${item.wd})`,
                            clouds: item.tcc,
                            visibility: item.vs_text,
                            iconUrl: item.image
                        });
                    });
                });
            } else {
                // Pola 2: Struktur Flat (Kecamatan & Desa Turen/Sedayu tipe file ini)
                prakiraanRaw.forEach(item => {
                    const d = new Date(item.waktu_lokal || item.local_datetime); // Handle variasi key waktu
                    results.push({
                        rawDate: d,
                        dateStr: d.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'short' }),
                        timeStr: d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                        temp: item.suhu_max || item.t, // Handle variasi key suhu
                        condition: item.kondisi || item.weather_desc, // Handle variasi key kondisi
                        humidity: item.kelembapan_min ? `${item.kelembapan_min}-${item.kelembapan_max}%` : `${item.hu}%`,
                        wind: item.kecepatan_angin ? `${item.kecepatan_angin} km/j (${item.arah_angin})` : `${item.ws} m/s`,
                        clouds: item.tcc,
                        visibility: item.vs_text ? item.vs_text : (item.vs ? (item.vs / 1000).toFixed(1) + ' km' : '-'),
                        iconUrl: item.image || null // Gunakan image jika ada
                    });
                });
            }

            // Sort by Date
            return results.sort((a, b) => a.rawDate - b.rawDate);
        }

        // --- Helper: Visuals & Safety Checks ---
        function getWeatherClass(condition) {
            if (!condition) return 'cloudy';
            const c = String(condition).toLowerCase(); // Paksa string untuk hindari error
            if (c.includes('hujan')) return 'rain';
            if (c.includes('petir')) return 'thunder';
            if (c.includes('berawan')) return 'cloudy';
            if (c.includes('cerah berawan')) return 'sunny'; 
            if (c.includes('cerah')) return 'clear';
            if (c.includes('kabut') || c.includes('asap')) return 'fog';
            return 'cloudy';
        }

        function getEmojiIcon(condition) {
            if (!condition) return '‚ùì'; // Safety Check
            const c = String(condition).toLowerCase(); // Paksa string untuk hindari error
            if (c.includes('hujan')) return 'üåßÔ∏è';
            if (c.includes('berawan')) return '‚òÅÔ∏è';
            if (c.includes('cerah')) return '‚òÄÔ∏è';
            if (c.includes('kabut') || c.includes('asap') || c.includes('kabur')) return 'üå´Ô∏è';
            if (c.includes('petir')) return '‚ö°';
            return 'üå§Ô∏è';
        }

    </script>
</body>
</html>